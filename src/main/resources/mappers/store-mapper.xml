<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "https:/mybatis.org/dtd/mybatis-3-mapper.dtd" >
 
 <mapper namespace="storeMapper">
 
 	<resultMap type="Store" id="storeResult">
 		<result column="STORE_NO" property="storeNo"/>
 		<result column="RMEM_NO" property="rmemNo"/>
 		<result column="LOCATION_BIG" property="locationBig"/>
 		<result column="LOCATION_SMALL" property="locationSmall"/>
 		<result column="STORE_ADDRESS" property="storeAddress"/>
 		<result column="STORE_ADDRESS_DETAIL" property="storeAddressDetail"/>
 		<result column="STORE_POST_NO" property="storePostNo"/>
 		<result column="STORE_NAME" property="storeName"/>
 		<result column="STORE_PHONE" property="storePhone"/>
 		<result column="MAX_MEMBER" property="maxMember"/>
 		<result column="STORE_WEEKDAY" property="storeWeekday"/>
 		<result column="STORE_WEEKEND" property="storeWeekend"/>
 		<result column="STORE_GROUP" property="storeGroup"/>
 		<result column="STORE_KIND" property="storeKind"/>
 		<result column="STORE_FISH_KIND" property="storeFishKind"/>
 		<result column="RESERVATION_DETAIL" property="reservationDetail"/>
 		<result column="BUSINESS_NO" property="businessNo"/>
 		<result column="STORE_STATUS" property="storeStatus"/>
 		<result column="LIKE_COUNT" property="likeCount"/>
 		<result column="MIN_PRICE" property="minPrice"/>
 		<result column="reply_count" property="replyCount"/>
 	</resultMap>
 	
 	<resultMap type="TicKet" id="ticketResult">
 		<result column="TICKET_NO" property="ticketNo"/>
 		<result column="RSTORE_NO" property="rstoreNo"/>
 		<result column="TICKET_NAME" property="ticketName"/>
 		<result column="TICKET_PRICE" property="ticketPrice"/>
 		<result column="TICKET_TIME" property="ticketTime"/>
 	</resultMap>
 	
 	<resultMap type="Slike" id="slikeResult">
 		<result column="RMEM_NO" property="rmemNo"/>
 		<result column="RSTORE_NO" property="rstoreNo"/>
 		<result column="STORE_GOOD_STATUS" property="storeGoodStatus"/>
 	</resultMap>
 
	<select id="checkBusinessNo" resultType="_int">
		SELECT COUNT(*)
		FROM STORE
		WHERE BUSINESS_NO = #{businessNo}
 	</select>

	<select id="storeCount" resultType="_int">
		SELECT COUNT(*)
		FROM STORE
		WHERE (STORE_KIND = 'FreshSeat'
		        OR STORE_KIND = 'FreshCafe')
		AND STORE_STATUS = 'op'
	</select>
	
	<select id="filteredStoreCount" resultType="_int">
		SELECT COUNT(*)
		FROM STORE
		WHERE LOCATION_BIG = #{locationBig}
		AND LOCATION_SMALL = #{locationSmall}
		AND STORE_STATUS = 'op'
	</select>

 	<select id="ajaxStoreList" resultMap="storeResult">
 		SELECT S.STORE_NO,
        S.STORE_ADDRESS,
        S.STORE_NAME,
        COUNT(DISTINCT G.RSTORE_NO) AS LIKE_COUNT,
        COALESCE(MIN(t.TICKET_PRICE), 0) AS min_price
		FROM STORE S
		LEFT JOIN STOREGOOD G ON S.STORE_NO = G.RSTORE_NO
        LEFT JOIN TICKET t ON s.STORE_NO = t.RSTORE_NO
		WHERE S.LOCATION_BIG = #{locationBig}
		  AND S.LOCATION_SMALL = #{locationSmall}
		  AND STORE_STATUS = 'op'
		GROUP BY S.STORE_NO, S.STORE_ADDRESS, S.STORE_NAME
 	</select>
 	
 	<select id="resDetailPage" resultMap="storeResult">
 		SELECT *
 		FROM STORE
 		WHERE STORE_NO = #{num}
 		AND STORE_STATUS = 'op'
 	</select>

 	<insert id="insertStore">
 	INSERT INTO STORE(
 						STORE_NO,
 						RMEM_NO,
 						LOCATION_BIG,
 						LOCATION_SMALL,
 						STORE_ADDRESS,
 						STORE_ADDRESS_DETAIL,
 						STORE_POST_NO,
 						STORE_NAME,
 						STORE_PHONE,
 						MAX_MEMBER,
 						STORE_WEEKDAY,
 						STORE_WEEKEND,
 						STORE_GROUP,
 						STORE_KIND,
 						STORE_FISH_KIND,
 						BUSINESS_NO
 						)
 				VALUES(
 						SEQ_STORE_NO.NEXTVAL,
 						SEQ_MEM_NO.CURRVAL,
 						#{locationBig},
 						#{locationSmall},
 						#{storeAddress},
 						#{storeAddressDetail},
 						#{storePostNo},
 						#{storeName},
 						#{storePhone},
 						#{maxMember},
 						#{storeWeekday},
 						#{storeWeekend},
 						#{storeGroup},
 						#{storeKind},
 						#{storeFishKind},
 						#{businessNo}
 				)
 	</insert>

 	<insert id="insertTicket">
 	INSERT INTO TICKET(
 						TICKET_NO,
 						RSTORE_NO,
 						TICKET_NAME,
 						TICKET_PRICE,
 						TICKET_TIME
 	)
 				VALUES(
 						SEQ_TICKET_NO.NEXTVAL,
 						SEQ_STORE_NO.CURRVAL,
 						#{ticketName},
 						#{ticketPrice},
 						#{ticketTime}
 	)
 	</insert>
	
 	<insert id="insertAttachment">
 	INSERT INTO ATTACHMENT(
 							FILE_NO,
 							ORIGIN_NAME,
 							CHANGE_NAME,
 							FILE_PATH,
 							RSTORE_NO
 							)
 				VALUES(
 						SEQ_FILE_NO.NEXTVAL,
 						#{originName},
 						#{changeName},
 						#{filePath},
 						SEQ_STORE_NO.CURRVAL
 						)
 	</insert>
 	
 	<select id="TicketTime" resultMap="ticketResult">
		SELECT *
		FROM TICKET
		WHERE RSTORE_NO = #{rstoreNo}
 	</select>
 	
 	<insert id="createLikeTable">
 		INSERT INTO STOREGOOD (RMEM_NO, RSTORE_NO)
		VALUES (#{memNo}, #{storeNum})
 	</insert>
 
 	<select id="checkLikeTable" resultMap="slikeResult">
 		SELECT *
		FROM STOREGOOD
		WHERE RMEM_NO = #{memNo}
		AND RSTORE_NO = #{storeNum}
 	</select>
 	
 	<select id="likeResult" resultMap="slikeResult">
 		SELECT STORE_GOOD_STATUS
		FROM STOREGOOD
		WHERE RMEM_NO = #{rmemNo}
		AND RSTORE_NO = #{rstoreNo}
 	</select>
 	
 	<update id="storeUpdateLike">
 		UPDATE STOREGOOD
		SET STORE_GOOD_STATUS = #{result}
		WHERE RSTORE_NO = #{rstoreNo}
		AND RMEM_NO = #{rmemNo}
 	</update>
 	
 	<select id="storeList" resultMap="storeResult">
 		SELECT 
		    s.STORE_NO,
		    s.STORE_ADDRESS,
		    s.STORE_NAME,
		    COUNT(DISTINCT CASE WHEN g.STORE_GOOD_STATUS = 'Y' THEN g.RSTORE_NO END) AS like_count,
		    COALESCE(MIN(t.TICKET_PRICE), 0) AS min_price,
            COUNT(DISTINCT CASE WHEN r.REPLY_STATUS = 'Y' THEN r.REPLY_NO END) AS reply_count
		FROM 
		    STORE s
		LEFT JOIN 
		    STOREGOOD g ON s.STORE_NO = g.RSTORE_NO
		LEFT JOIN 
		    TICKET t ON s.STORE_NO = t.RSTORE_NO
        LEFT JOIN 
		    REPLY r ON s.STORE_NO = r.RSTORE_NO
		WHERE STORE_KIND = 'FreshSeat'
		        OR STORE_KIND = 'FreshCafe'
		AND STORE_STATUS = 'op'
		GROUP BY 
		    s.STORE_NO, s.STORE_ADDRESS, s.STORE_NAME
		ORDER BY 
		    like_count DESC
	</select>
	
	<select id="seaStoreCount" resultType="_int">
		SELECT COUNT(*)
		FROM STORE
		WHERE STORE_KIND = 'seaShip'
        OR STORE_KIND = 'seaSeat'
        AND STORE_STATUS = 'op'
	</select>
	
	<select id="seaStoreList" resultMap="storeResult">
 		SELECT 
		    s.STORE_NO,
		    s.STORE_ADDRESS,
		    s.STORE_NAME,
		    COUNT(DISTINCT CASE WHEN g.STORE_GOOD_STATUS = 'Y' THEN g.RSTORE_NO END) AS like_count,
		    COALESCE(MIN(t.TICKET_PRICE), 0) AS min_price,
            COUNT(DISTINCT CASE WHEN r.REPLY_STATUS = 'Y' THEN r.REPLY_NO END) AS reply_count
		FROM 
		    STORE s
		LEFT JOIN 
		    STOREGOOD g ON s.STORE_NO = g.RSTORE_NO
		LEFT JOIN 
		    TICKET t ON s.STORE_NO = t.RSTORE_NO
        LEFT JOIN 
		    REPLY r ON s.STORE_NO = r.RSTORE_NO
		WHERE STORE_KIND = 'seaShip'
		        OR STORE_KIND = 'seaSeat'
		AND STORE_STATUS = 'op'
		GROUP BY 
		    s.STORE_NO, s.STORE_ADDRESS, s.STORE_NAME
		ORDER BY 
		    like_count DESC
	</select>
 
	 <select id="ajaxSeaStoreCount" resultType="_int">
			SELECT COUNT(*)
			FROM (SELECT *
                    FROM STORE
                    WHERE STORE_KIND = 'seaShip'
                    OR STORE_KIND = 'seaSeat')
            WHERE LOCATION_SMALL = #{city1}
            OR LOCATION_SMALL = #{city2}
            OR LOCATION_SMALL = #{city3}
            OR LOCATION_SMALL = #{city4}
            OR LOCATION_SMALL = #{city5}
            OR LOCATION_SMALL = #{city6}
            AND STORE_STATUS = 'op'
	</select>
	
	<select id="ajaxSeaStoreList" resultMap="storeResult">
 		SELECT *
		FROM (SELECT 
				    s.STORE_NO,
				    s.STORE_ADDRESS,
				    s.STORE_NAME,
				    COUNT(DISTINCT CASE WHEN g.STORE_GOOD_STATUS = 'Y' THEN g.RSTORE_NO END) AS like_count,
				    COALESCE(MIN(t.TICKET_PRICE), 0) AS min_price,
		            s.LOCATION_SMALL,
		            COUNT(DISTINCT CASE WHEN r.REPLY_STATUS = 'Y' THEN r.REPLY_NO END) AS reply_count
				FROM 
				    STORE s
				LEFT JOIN 
				    STOREGOOD g ON s.STORE_NO = g.RSTORE_NO
				LEFT JOIN 
				    TICKET t ON s.STORE_NO = t.RSTORE_NO
				LEFT JOIN 
		    		REPLY r ON s.STORE_NO = r.RSTORE_NO    
				WHERE (s.STORE_KIND = 'seaShip'
				        OR s.STORE_KIND = 'seaSeat')
				AND s.STORE_STATUS = 'op'
				GROUP BY 
				    s.STORE_NO, s.STORE_ADDRESS, s.STORE_NAME, s.LOCATION_SMALL
				ORDER BY 
				    like_count DESC)
		WHERE (LOCATION_SMALL = #{city1}
        OR LOCATION_SMALL = #{city2}
        OR LOCATION_SMALL = #{city3}
        OR LOCATION_SMALL = #{city4}
        OR LOCATION_SMALL = #{city5}
        OR LOCATION_SMALL = #{city6})
	</select>
	
	<select id="selectMyStoreList" resultMap="storeResult">
		SELECT STORE_NO,
			RMEM_NO,
			LOCATION_BIG,
			LOCATION_SMALL,
			STORE_ADDRESS,
			STORE_ADDRESS_DETAIL,
			STORE_POST_NO,
			STORE_NAME,
			STORE_PHONE,
			MAX_MEMBER,
			STORE_WEEKDAY,
			STORE_WEEKEND,
			STORE_GROUP,
			STORE_KIND,
			STORE_FISH_KIND,
			BUSINESS_NO
		FROM STORE
		WHERE RMEM_NO = #{memNo}	
	</select>
	
	<select id="ajaxSeaStoreCountFA" resultType="_int">
		SELECT COUNT(*)
		FROM STORE
		<if test="filterNum == 1"> 
        WHERE STORE_KIND = 'seaShip'
        </if>
        <if test="filterNum == 2"> 
        WHERE STORE_KIND = 'seaSeat'
        </if>
        <if test="filterNum == 3"> 
        WHERE (STORE_KIND = 'seaShip'
        OR STORE_KIND = 'seaSeat')
        </if>
        AND STORE_STATUS = 'op'
	</select>
	
	<select id="ajaxSeaStoreCountFB" resultType="_int">
			SELECT COUNT(*)
			FROM (SELECT *
                    FROM STORE
                    <if test="filterNum == 1"> 
                    WHERE STORE_KIND = 'seaShip'
                    </if>
                    <if test="filterNum == 2"> 
                    WHERE STORE_KIND = 'seaSeat'
                    </if>
                    <if test="filterNum == 3"> 
                    WHERE STORE_KIND = 'seaShip'
                    OR STORE_KIND = 'seaSeat'
                    </if>
                    )
            WHERE LOCATION_SMALL = #{city1}
            OR LOCATION_SMALL = #{city2}
            OR LOCATION_SMALL = #{city3}
            OR LOCATION_SMALL = #{city4}
            OR LOCATION_SMALL = #{city5}
            OR LOCATION_SMALL = #{city6}
            AND STORE_STATUS = 'op'
	</select>
	
	<select id="ajaxStoreKindFilterA" resultMap="storeResult">
 		SELECT 
		    s.STORE_NO,
		    s.STORE_ADDRESS,
		    s.STORE_NAME,
		    COUNT(DISTINCT CASE WHEN g.STORE_GOOD_STATUS = 'Y' THEN g.RSTORE_NO END) AS like_count,
		    COALESCE(MIN(t.TICKET_PRICE), 0) AS min_price,
            COUNT(DISTINCT CASE WHEN r.REPLY_STATUS = 'Y' THEN r.REPLY_NO END) AS reply_count
		FROM 
		    STORE s
		LEFT JOIN 
		    STOREGOOD g ON s.STORE_NO = g.RSTORE_NO
		LEFT JOIN 
		    TICKET t ON s.STORE_NO = t.RSTORE_NO
        LEFT JOIN 
		    REPLY r ON s.STORE_NO = r.RSTORE_NO
		WHERE (
				<if test="filterNum == 1"> 
                 STORE_KIND = 'seaShip'
                </if>
                <if test="filterNum == 2"> 
                 STORE_KIND = 'seaSeat'
                 </if>
                <if test="filterNum == 3"> 
                STORE_KIND = 'seaShip'
                OR STORE_KIND = 'seaSeat'
                </if>
		        )
		AND STORE_STATUS = 'op'
		GROUP BY 
		    s.STORE_NO, s.STORE_ADDRESS, s.STORE_NAME
		ORDER BY 
		    like_count DESC
	</select>
	
	<select id="ajaxStoreKindFilterB" resultMap="storeResult">
 		SELECT *
		FROM (SELECT 
				    s.STORE_NO,
				    s.STORE_ADDRESS,
				    s.STORE_NAME,
				    COUNT(DISTINCT CASE WHEN g.STORE_GOOD_STATUS = 'Y' THEN g.RSTORE_NO END) AS like_count,
				    COALESCE(MIN(t.TICKET_PRICE), 0) AS min_price,
		            s.LOCATION_SMALL,
		            COUNT(DISTINCT CASE WHEN r.REPLY_STATUS = 'Y' THEN r.REPLY_NO END) AS reply_count
				FROM 
				    STORE s
				LEFT JOIN 
				    STOREGOOD g ON s.STORE_NO = g.RSTORE_NO
				LEFT JOIN 
				    TICKET t ON s.STORE_NO = t.RSTORE_NO
				LEFT JOIN 
		    		REPLY r ON s.STORE_NO = r.RSTORE_NO
				WHERE (
					<if test="filterNum == 1"> 
                     s.STORE_KIND = 'seaShip'
                     </if>
                    <if test="filterNum == 2"> 
                     s.STORE_KIND = 'seaSeat'
                     </if>
                    <if test="filterNum == 3"> 
                    s.STORE_KIND = 'seaShip'
                    OR s.STORE_KIND = 'seaSeat'
                    </if>
				        )
				AND s.STORE_STATUS = 'op'
				GROUP BY 
				    s.STORE_NO, s.STORE_ADDRESS, s.STORE_NAME, s.LOCATION_SMALL
				ORDER BY 
				    like_count DESC)
		WHERE (LOCATION_SMALL = #{city1}
        OR LOCATION_SMALL = #{city2}
        OR LOCATION_SMALL = #{city3}
        OR LOCATION_SMALL = #{city4}
        OR LOCATION_SMALL = #{city5}
        OR LOCATION_SMALL = #{city6})
	</select>
	
	<insert id="storeEnroll">
	INSERT INTO STORE(
 						STORE_NO,
 						RMEM_NO,
 						LOCATION_BIG,
 						LOCATION_SMALL,
 						STORE_ADDRESS,
 						STORE_ADDRESS_DETAIL,
 						STORE_POST_NO,
 						STORE_NAME,
 						STORE_PHONE,
 						MAX_MEMBER,
 						STORE_WEEKDAY,
 						STORE_WEEKEND,
 						STORE_GROUP,
 						STORE_KIND,
 						STORE_FISH_KIND,
 						BUSINESS_NO
 						)
 				VALUES(
 						SEQ_STORE_NO.NEXTVAL,
 						#{rmemNo},
 						#{locationBig},
 						#{locationSmall},
 						#{storeAddress},
 						#{storeAddressDetail},
 						#{storePostNo},
 						#{storeName},
 						#{storePhone},
 						#{maxMember},
 						#{storeWeekday},
 						#{storeWeekend},
 						#{storeGroup},
 						#{storeKind},
 						#{storeFishKind},
 						#{businessNo}
 				)
	</insert>
	<select id="myStoreList" resultMap="storeResult">
		SELECT *
		FROM STORE
		JOIN MEMBER ON RMEM_NO = MEM_NO
		WHERE RMEM_NO = #{memNo}
	</select>
	<select id="detailInfo" resultType="string">
		SELECT RESERVATION_DETAIL
		FROM STORE
		WHERE STORE_NO = #{storeNum}
	</select>
	<update id="updateDetailInfo">
		UPDATE STORE
		SET reservation_detail = #{info}
		WHERE STORE_NO = #{storeNum}
	</update>
	<select id="selectedTicket" resultMap="ticketResult">
		SELECT *
		FROM TICKET
		WHERE TICKET_NO = #{ticketNo}
	</select>
 </mapper>